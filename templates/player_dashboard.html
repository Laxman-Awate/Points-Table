<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Player Dashboard</title>
  <link href="{{ url_for('static', filename='dist/output.css') }}" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-green-200 via-blue-200 to-purple-300 min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">üéÆ Player Dashboard</h1>

  <!-- Player Info -->
  <section class="bg-white p-6 rounded-xl shadow-md mb-6">
    <h3 class="font-semibold text-lg mb-3">üë§ Your Info</h3>
    <p id="player-name" class="text-lg font-medium"></p>
    <p id="player-team" class="text-lg font-medium"></p>
    <p>Total Score: <span id="player-score" class="font-bold">0</span></p>
  </section>

  <!-- Start Scan -->
  <section class="bg-white p-6 rounded-xl shadow-md mb-6">
    <button id="btn-scan" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
      Scan QR
    </button>

    <!-- Scan Links (appear after scan) -->
    <div id="scan-links" class="mt-4 hidden">
      <h4 class="font-semibold text-md mb-2">üéÅ Scan Links</h4>
      <ul id="links-container" class="space-y-2 list-disc pl-6"></ul>
    </div>
  </section>

  <!-- Leaderboard -->
  <section class="bg-white p-6 rounded-xl shadow-md">
    <h3 class="font-semibold text-lg mb-3">üèÜ Leaderboard by Team</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-300 bg-white rounded-lg text-sm">
        <thead class="bg-gray-200 sticky top-0">
          <tr>
            <th class="border p-3 text-center">Rank</th>
            <th class="border p-3 text-center">Team</th>
            <th class="border p-3 text-center">Player</th>
            <th class="border p-3 text-center">QR</th>
            <th class="border p-3 text-center">Treasure</th>
            <th class="border p-3 text-center">Game 1</th>
            <th class="border p-3 text-center">Game 2</th>
            <th class="border p-3 text-center">Reel</th>
            <th class="border p-3 text-center">Total</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body"></tbody>
      </table>
    </div>
  </section>

  <script>
    const username = localStorage.getItem("username");
    const team = localStorage.getItem("team");
    const scoreEl = document.getElementById("player-score");

    if(!username || !team){
      alert("Please login again!");
      window.location.href = "/";
    }

    document.getElementById("player-name").textContent = "Name: " + username;
    document.getElementById("player-team").textContent = "Team: " + team;

    // Dummy links
    const dummyLinks = [
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/arsh", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/rishab", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/sama", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/firdaus", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/rashmi", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/maaz", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/naveli", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/girish", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/laxman", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/mahesh", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/namrata", points: 1 },
      { url: "https://maaz-code-hub.github.io/GSA-prompt-launcher/arshan", points: 1 }
    ];

    // Load leaderboard
    async function loadLeaderboard() {
      try {
        const res = await fetch("/api/players");
        const data = await res.json();
        const tbody = document.getElementById("leaderboard-body");
        tbody.innerHTML = "";

        // Ensure player is present
        if(!data.players.some(p=>p.username===username)){
          data.players.push({
            username, team,
            qr_points:0, treasure_points:0, game1_points:0,
            game2_points:0, reel_points:0, score:0
          });
        }

        // Group by team
        const teams = {};
        data.players.forEach(p=>{
          if(!teams[p.team]) teams[p.team]=[];
          teams[p.team].push(p);
        });

        // Calculate totals
        const teamTotals = Object.keys(teams).map(teamId=>{
          const total = teams[teamId].reduce((sum,p)=>sum+(p.score||0),0);
          return {teamId, total, players: teams[teamId]};
        });

        teamTotals.sort((a,b)=>b.total - a.total);
        let rank=1;

        teamTotals.forEach(teamData=>{
          // Team row
          const teamRow = document.createElement("tr");
          teamRow.classList.add("bg-gray-200","font-semibold");
          teamRow.innerHTML = `
            <td class="border p-2 text-center">${rank}</td>
            <td class="border p-2 text-center">${teamData.teamId} (Total)</td>
            <td class="border p-2 text-center" colspan="6"></td>
            <td class="border p-2 text-center">${teamData.total}</td>
          `;
          tbody.appendChild(teamRow);

          // Players
          teamData.players.sort((a,b)=>b.score - a.score);
          teamData.players.forEach((p, idx)=>{
            const row = document.createElement("tr");
            if(p.username===username){
              row.classList.add("bg-yellow-100","font-semibold");
              scoreEl.textContent = p.score;
            } else {
              row.classList.add(idx%2===0?"bg-white":"bg-gray-50");
            }
            row.classList.add("hover:bg-gray-100");
            row.innerHTML = `
              <td class="border p-2 text-center"></td>
              <td class="border p-2 text-center"></td>
              <td class="border p-2 text-center">${p.username}</td>
              <td class="border p-2 text-center">${p.qr_points||0}</td>
              <td class="border p-2 text-center">${p.treasure_points||0}</td>
              <td class="border p-2 text-center">${p.game1_points||0}</td>
              <td class="border p-2 text-center">${p.game2_points||0}</td>
              <td class="border p-2 text-center">${p.reel_points||0}</td>
              <td class="border p-2 text-center">${p.score}</td>
            `;
            tbody.appendChild(row);
          });
          rank++;
        });

      } catch(err){ console.error(err); }
    }

    // Show scan links
    function showScanLinks(){
      const container = document.getElementById("links-container");
      container.innerHTML = "";

      dummyLinks.forEach(linkObj=>{
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = linkObj.url;
        a.target = "_blank";
        a.textContent = linkObj.url;
        a.className = "text-blue-600 hover:underline";

        // Add click event to award points
        a.addEventListener("click", async () => {
          try {
            const res = await fetch("/api/player/score", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username: username,
                category: "qr_points",
                points: linkObj.points
              })
            });
            const data = await res.json();
            if(data.ok){
              alert(`You earned ${linkObj.points} point(s)! Total: ${data.score}`);
              loadLeaderboard();
            }
          } catch(err){ console.error(err); }
        });

        li.appendChild(a);
        container.appendChild(li);
      });

      document.getElementById("scan-links").classList.remove("hidden");
    }

    // Scan QR button now only shows links
    document.getElementById("btn-scan").addEventListener("click", showScanLinks);

    // Load leaderboard initially and refresh every 2 seconds
    loadLeaderboard();
    setInterval(loadLeaderboard, 2000);

  </script>
</body>
</html>
